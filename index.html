<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Precificação de Veículos</title>
    <style>
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        margin: 0;
        color: #333;
        line-height: 1.4;

        /* ==============================
           FUNDO COM LOGO (MARCA D'ÁGUA)
           - Logo menor
           - Mais clara
           - Repetida para cobrir todo o "vazio"
           ============================== */
        background-color: #f5f7fa;
        background-image:
          linear-gradient(
            /* Aumenta a visibilidade ("brilho") da marca d'água */
            rgba(245, 247, 250, 0.975),
            rgba(245, 247, 250, 0.975)
          ),
          url("SM_MULTIMARCAS_preto.png");
        background-repeat: repeat;
        background-position: top left;
        background-size: 340px auto;
        background-attachment: scroll;
      }

      h1 {
        text-align: center;
        margin: 2rem 1rem 1rem;
        position: relative;
        z-index: 2;
        font-size: 2.35rem;
        letter-spacing: -0.5px;
        color: #2b2f36;
      }

      form {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.96));
        border: 1px solid rgba(20, 30, 50, 0.12);
        border-radius: 14px;
        padding: 2.2rem;
        max-width: 720px;
        margin: 2rem auto;
        box-shadow: 0 14px 34px rgba(20, 30, 50, 0.10);
        position: relative;
        z-index: 2;
        overflow: hidden;
      }

      /* Faixa superior elegante no card do formulário */
      form::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #007bff 0%, #00a8ff 100%);
      }

      label {
        display: block;
        margin-top: 1.15rem;
        font-weight: 700;
        font-size: 0.98rem;
        color: #1f2d5c;
      }

      input,
      select {
        width: 100%;
        padding: 0.75rem 0.85rem;
        margin-top: 0.45rem;
        border: 1px solid rgba(31, 45, 92, 0.18);
        border-radius: 10px;
        box-sizing: border-box;
        font-size: 0.98rem;
        background-color: #fff;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        outline: none;
      }

      input:focus,
      select:focus {
        border-color: rgba(0, 123, 255, 0.65);
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.14);
      }

      /* Linha de margem (select + input) */
      .margem-row {
        display: grid;
        grid-template-columns: 190px 1fr;
        gap: 0.75rem;
        align-items: center;
        margin-top: 0.45rem;
      }

      /* Evita que inputs/ selects ganhem margin-top dentro do grid */
      .margem-row input,
      .margem-row select {
        margin-top: 0;
      }

      button {
        margin-top: 1.8rem;
        padding: 0.9rem 2.2rem;
        background: linear-gradient(135deg, #2e6bff 0%, #007bff 60%, #00a8ff 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.02rem;
        font-weight: 800;
        letter-spacing: 0.6px;
        box-shadow: 0 10px 22px rgba(0, 123, 255, 0.22);
        /* Centraliza o botão dentro do formulário */
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      button:hover {
        filter: brightness(0.96);
      }

      .resultado {
        margin-top: 2rem;
        padding: 1rem;
        background-color: #e9ecef;
        border-radius: 8px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        z-index: 2;
      }

      .resultado h2 {
        margin-top: 0;
      }

      .resultado ul {
        list-style-type: none;
        padding-left: 0;
      }

      .resultado li {
        margin-bottom: 0.5rem;
      }

      /* Ajuste do valor máximo: apenas remove a margem inferior. */
      #valorPagamento {
        margin-bottom: 0;
      }

      /* Estilo para card KPI: destaque elegante e centralizado */
      .kpi-card {
        border: 4px solid #0045b3;
        background: linear-gradient(135deg, #f9fbff 0%, #e7f1ff 100%);
        border-radius: 12px;
        padding: 2rem 1.5rem;
        margin: 1.5rem auto;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
        box-shadow: 0 8px 22px rgba(0, 69, 179, 0.22);
        transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
      }

      .kpi-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 26px rgba(0, 69, 179, 0.3);
      }

      .kpi-card .kpi-label {
        font-size: 1.2rem;
        color: #0045b3;
        font-weight: 600;
        margin-bottom: 0.8rem;
      }

      .kpi-card .kpi-value {
        font-size: 3.5rem;
        font-weight: 700;
        color: #0045b3;
        line-height: 1.05;
      }

      /* Estilo menor para os centavos dentro da KPI */
      .kpi-card .kpi-value .decimais {
        font-size: 0.5em;
      }

      /* ==========================
         NOVO: "PÍLULA" % DA FIPE
         ========================== */
      .kpi-subinfo {
        margin-top: 0.75rem;
        display: flex;
        justify-content: center;
      }

      .kpi-pill {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid rgba(0, 69, 179, 0.15);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);

        font-weight: 700;
        color: #1f2d5c;
        font-size: 1rem;
      }

      .kpi-pill .kpi-pill-text {
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
        line-height: 1;
      }

      .kpi-pill .kpi-pill-text .pct {
        letter-spacing: 0.2px;
      }

      .kpi-pill .kpi-pill-icon {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 2px solid #ff7a00;
        color: #ff7a00;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 900;
        line-height: 1;
        flex: 0 0 auto;
      }

      /* ==============================
         DESTAQUE SUTIL (INDICADOR-CHAVE)
         Campo: "Por quanto você acha que vende o veículo?"
         ============================== */
      :root{
        --pri-accent: #2f6df6;
        --pri-accent-2: #6aa8ff;
        --pri-bg: #f3f7ff;
        --pri-border: #d7e2ff;
        --pri-text: #0f172a;
        --pri-muted: #64748b;
      }

      .priority-field{
        position: relative;
        border-radius: 16px;
        padding: 16px 16px 12px 16px;
        margin-top: 0.6rem; /* substitui o espaçamento do label padrão */
        background: linear-gradient(180deg, rgba(47,109,246,.06), rgba(47,109,246,.02));
        border: 1px solid var(--pri-border);
        box-shadow: 0 10px 26px rgba(15, 23, 42, .06);
        overflow: hidden;
      }

      /* linha superior “premium” */
      .priority-field::before{
        content:"";
        position:absolute;
        top:0; left:0; right:0;
        height: 3px;
        background: linear-gradient(90deg, var(--pri-accent), var(--pri-accent-2));
        opacity: .85;
      }

      .priority-header{
        display:flex;
        align-items:flex-start;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .priority-label{
        display:block;
        margin: 0;
        font-weight: 800;
        font-size: 1.35rem;
        line-height: 1.15;
        color: var(--pri-text);
        letter-spacing: -0.2px;
      }

      /* (mantido no CSS, mas o elemento foi removido do HTML) */
      .priority-badge{
        font-size: 12px;
        font-weight: 800;
        letter-spacing: .4px;
        padding: 7px 10px;
        border-radius: 999px;
        color: rgba(47,109,246,.95);
        background: rgba(47,109,246,.10);
        border: 1px solid rgba(47,109,246,.20);
        white-space: nowrap;
      }

      .priority-input-wrap{
        border-radius: 14px;
        padding: 12px 14px;
        background: var(--pri-bg);
        border: 1px solid rgba(15, 23, 42, .12);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.75);
        transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      }

      .priority-input{
        width: 100%;
        border: 0 !important;
        outline: none;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 1.6rem;
        font-weight: 900;
        color: var(--pri-text);
        letter-spacing: .2px;
      }

      .priority-hint{
        margin-top: 10px;
        font-size: 0.86rem;
        color: var(--pri-muted);
      }

      .priority-field:focus-within .priority-input-wrap{
        border-color: rgba(47,109,246,.45);
        box-shadow:
          0 14px 34px rgba(47,109,246,.14),
          inset 0 1px 0 rgba(255,255,255,.8);
        transform: translateY(-1px);
      }

      /* pulso discreto quando o valor muda */
      .priority-field.pulse{
        animation: priPulse .6s ease-out;
      }
      @keyframes priPulse{
        0%   { box-shadow: 0 10px 26px rgba(15, 23, 42, .06); }
        40%  { box-shadow: 0 18px 44px rgba(47,109,246,.18); }
        100% { box-shadow: 0 10px 26px rgba(15, 23, 42, .06); }
      }

      /* Ajustes responsivos para visualização mobile */
      @media (max-width: 600px) {
        body {
          background-size: 260px auto;
        }

        .kpi-card .kpi-value {
          font-size: 2.8rem;
        }

        .kpi-card .kpi-label {
          font-size: 1rem;
        }

        .kpi-pill {
          font-size: 0.95rem;
          padding: 0.42rem 0.85rem;
        }
      }

      /* Estilo para boxes de detalhes separados por setor */
      .detalhes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        grid-gap: 1rem;
        margin-top: 1.5rem;
      }

      .detalhes-box {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-top: 4px solid #007bff;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .detalhes-box h4 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
        color: #007bff;
      }

      .detalhes-box ul {
        list-style-type: disc;
        padding-left: 1rem;
        margin-top: 0;
      }

      .detalhes-box li {
        margin-bottom: 0.4rem;
      }

      .legenda {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1.5rem auto;
        max-width: 800px;
        justify-content: center;
        font-size: 0.9rem;
        color: #333;
      }

      .legenda h3 {
        flex-basis: 100%;
        text-align: center;
        font-size: 1rem;
        margin: 0 0 0.5rem 0;
        color: #007bff;
      }

      .legenda details {
        flex: 1 1 300px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        padding: 0.75rem 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .legenda summary {
        font-weight: bold;
        color: #007bff;
        cursor: pointer;
        margin-bottom: 0.5rem;
      }

      .legenda ul {
        list-style-type: disc;
        padding-left: 1.2rem;
        margin-top: 0;
      }

      .observacao {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
        /* Tornar as observações em itálico para destacá-las das perguntas */
        font-style: italic;
      }

      /* ====== Estilo aprimorado para cards de detalhes ====== */
      .detalhes-box {
        position: relative;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        /* Sobrescreve eventual borda superior azul definida anteriormente */
        border-top: none !important;
        border-radius: 10px;
        padding: 1rem 1rem 1.2rem 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .detalhes-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #007bff 0%, #00a8ff 100%);
      }

      .detalhes-box h4 {
        margin-top: 0;
        margin-bottom: 0.75rem;
        font-size: 1.15rem;
        font-weight: 700;
        color: #1f2d5c;
        text-align: center;
      }

      .detalhes-box ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .detalhes-box li {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.5rem;
        line-height: 1.3;
        color: #555;
      }

      .detalhes-box li .det-texto {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .detalhes-box li .descricao {
        font-weight: 600;
        color: #0045b3;
      }

      .detalhes-box li .subinfo {
        font-style: italic;
        font-size: 0.85em;
        color: #6c757d;
      }

      .detalhes-box li .valor {
        font-weight: 600;
        color: #1f2d5c;
        white-space: nowrap;
        /* Empurra o valor para a direita, mantendo a descrição próxima */
        margin-left: auto;
      }

      /* Separador elegante dentro dos boxes (usado no "Custos fixos - NBS") */
      .det-separator {
        border: none;
        border-top: 1px solid rgba(0, 69, 179, 0.35);
        margin: 0.75rem 0 0.85rem;
      }
    </style>
  </head>

  <body>
    <h1>Sistema de Precificação de Veículos</h1>

    <form id="formAvaliacao">
      <!-- INDICADOR-CHAVE: destaque sutil e elegante -->
      <div class="priority-field" id="priorityValorVenda">
        <div class="priority-header">
          <label for="valorVenda" class="priority-label">Por quanto você acha que vende o veículo?</label>
          <!-- REMOVIDO: frase/etiqueta "INDICADOR-CHAVE" -->
        </div>

        <div class="priority-input-wrap">
          <input type="text" id="valorVenda" name="valorVenda" value="0,00" required class="priority-input" />
        </div>

        <div class="priority-hint"></div>
      </div>

      <label for="numPneus">Quantidade de pneus a substituir:</label>
      <select id="numPneus" name="numPneus">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>

      <label for="numLataria">Quantidade de peças de lataria a reparar:</label>
      <select id="numLataria" name="numLataria">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
      </select>

      <label for="reparosDiversos">Prévia de Manutenção:</label>
      <input type="text" id="reparosDiversos" name="reparosDiversos" value="R$ 1.200,00" />
      <div class="observacao">O valor de R$ 1.200,00 é fixo, porém o campo é editável.</div>

      <label for="pagarIpva">Teremos que pagar o IPVA?</label>
      <select id="pagarIpva" name="pagarIpva">
        <option value="nao" selected>Não</option>
        <option value="sim">Sim</option>
      </select>
      <div class="observacao">
        Se marcado "Sim", será considerado 3% do valor da Tabela Fipe como custo adicional de IPVA.
      </div>

      <label for="margemPercent">Margem desejada:</label>
      <div class="margem-row">
        <select id="margemTipo" name="margemTipo" aria-label="Tipo de margem">
          <option value="percent" selected>Margem em %</option>
          <option value="valor">Margem em R$</option>
        </select>

        <!-- Mantém a margem em % (comportamento original) -->
        <input type="number" id="margemPercent" name="margemPercent" step="0.01" min="0" max="100" required />

        <!-- Alternativa: margem em R$ -->
        <input type="text" id="margemValor" name="margemValor" value="R$ 0,00" style="display: none" />
      </div>
      <div class="observacao" id="margemObs">Informe a margem como porcentagem. Por exemplo, digite 15 para 15%.</div>

      <label for="valorFipe">Valor da Tabela Fipe:</label>
      <input type="text" id="valorFipe" name="valorFipe" value="0,00" required />
      <div class="observacao">Informe o valor de referência da Tabela Fipe para este modelo de veículo.</div>

      <!-- Botão renomeado para "PRECIFICAR" com centralização mantida -->
      <button type="submit">PRECIFICAR</button>
    </form>

    <div id="resultado" class="resultado" style="display: none">
      <div class="kpi-card">
        <div class="kpi-label">Valor máximo a ser pago no veículo</div>

        <div class="kpi-value" id="valorPagamento"></div>

        <!-- NOVO: badge logo abaixo do valor do KPI -->
        <div class="kpi-subinfo" id="kpiFipeInfo" style="display: none">
          <div class="kpi-pill">
            <span class="kpi-pill-text">
              <span class="pct" id="kpiFipePercent">0.00%</span>
              <span>da FIPE</span>
            </span>
            <span class="kpi-pill-icon">!</span>
          </div>
        </div>
      </div>

      <div id="detalhesLista"></div>
    </div>

    <script>
      (function () {
        const CUSTO_PECA_LATARIA = 450.0;
        const CUSTO_PNEU = 500.0;

        const CUSTO_PUBLICIDADE = 400.0;
        const CUSTO_HIGIENIZACAO = 200.0;
        const CUSTO_POLIMENTO = 150.0;
        // Ajuste solicitado: transferência = R$ 193,00
        const CUSTO_TRANSFERENCIA = 193.0;
        const CUSTO_REVISAO_PATIO = 75.0;
        const CUSTO_LAVAGEM = 29.5;
        const CUSTO_ABRACAF = 137.98;
        const CUSTO_CARTORIO = 23.0;

        const PERCENTUAL_COMISSAO = 0.005;
        const PERCENTUAL_ENCARGOS_COMISSAO = 0.005;
        const PERCENTUAL_JURO_FLOOR = 0.015;

        const PIS_COFINS_PERCENT = 0.0365;
        const ICMS_PERCENT = 0.0085;

        function formatarMoeda(valor) {
          return valor.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
            minimumFractionDigits: 2,
          });
        }

        function parseMoedaTexto(texto) {
          if (!texto) return 0;
          const soNumeros = texto
            .replace(/\s/g, "")
            .replace("R$", "")
            .replace(/\./g, "")
            .replace(",", ".");
          const valor = parseFloat(soNumeros);
          return isNaN(valor) ? 0 : valor;
        }

        function formatarInputMoeda(input) {
          const valor = parseMoedaTexto(input.value);
          input.value = valor.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
            minimumFractionDigits: 2,
          });
        }

        function limparSeZero(event) {
          const input = event.target;
          const valorNumerico = parseMoedaTexto(input.value);
          if (valorNumerico === 0) {
            input.value = "";
          }
        }

        function calcularPagamento(param) {
          const custoPneusTotal = param.numPneus * CUSTO_PNEU;
          const custoLatariaTotal = param.numLataria * CUSTO_PECA_LATARIA;

          const comissaoVendedor = PERCENTUAL_COMISSAO * param.valorVenda;

          const margemPercentual = typeof param.margemPercentual === "number" && !isNaN(param.margemPercentual)
            ? param.margemPercentual
            : 0;

          // Agora suportamos margem em % ou em R$ (valor absoluto)
          const margemValor =
            param.margemTipo === "valor"
              ? Math.max(0, param.margemValorInformado || 0)
              : (Math.max(0, margemPercentual) / 100.0) * param.valorVenda;

          const custoReparosDiversos = param.reparosDiversos || 0;

          const custoIpva = param.pagamentoIpva && param.valorFipe ? 0.03 * param.valorFipe : 0;

          const outrosCustos =
            custoPneusTotal +
            custoLatariaTotal +
            custoReparosDiversos +
            custoIpva +
            CUSTO_PUBLICIDADE +
            CUSTO_HIGIENIZACAO +
            CUSTO_POLIMENTO +
            CUSTO_TRANSFERENCIA +
            CUSTO_REVISAO_PATIO +
            CUSTO_LAVAGEM +
            CUSTO_CARTORIO +
            CUSTO_ABRACAF;

          const revenueCoefficient =
            1 - (PERCENTUAL_COMISSAO + PERCENTUAL_ENCARGOS_COMISSAO + ICMS_PERCENT + PIS_COFINS_PERCENT);

          const numerador = revenueCoefficient * param.valorVenda - outrosCustos - margemValor;
          const denominador = 1 + PERCENTUAL_JURO_FLOOR - PIS_COFINS_PERCENT;

          let valorPagamento = numerador / denominador;
          if (valorPagamento < 0) valorPagamento = 0;

          const jurosFloorPlan = PERCENTUAL_JURO_FLOOR * valorPagamento;
          const custoIcms = ICMS_PERCENT * param.valorVenda;
          const custoPisCofins = PIS_COFINS_PERCENT * (param.valorVenda - valorPagamento);

          const encargosComissao = PERCENTUAL_ENCARGOS_COMISSAO * param.valorVenda;

          const lucroEfetivo =
            param.valorVenda -
            comissaoVendedor -
            encargosComissao -
            custoIcms -
            custoPisCofins -
            (valorPagamento + jurosFloorPlan + outrosCustos);

          let diferencaFipe = null;
          let percentualPagamentoSobreFipe = null;
          let percentualPagamentoSobreFipePct = null;

          if (param.valorFipe && param.valorFipe > 0) {
            diferencaFipe = valorPagamento - param.valorFipe;
            percentualPagamentoSobreFipe = valorPagamento / param.valorFipe;
            percentualPagamentoSobreFipePct = percentualPagamentoSobreFipe * 100;
          }

          return {
            valorPagamento,
            detalhes: {
              comissaoVendedor,
              encargosComissao,
              jurosFloorPlan,
              custoPneusTotal,
              custoLatariaTotal,
              custoCartorio: CUSTO_CARTORIO,
              custoAbracaf: CUSTO_ABRACAF,
              custoPublicidade: CUSTO_PUBLICIDADE,
              custoHigienizacao: CUSTO_HIGIENIZACAO,
              custoPolimento: CUSTO_POLIMENTO,
              custoTransferencia: CUSTO_TRANSFERENCIA,
              custoRevisaoPatio: CUSTO_REVISAO_PATIO,
              custoLavagem: CUSTO_LAVAGEM,
              custoReparosDiversos: custoReparosDiversos,
              custoIpva: custoIpva,
              custoPisCofins: custoPisCofins,
              custoIcms: custoIcms,
              outrosCustos,
              margemValor,
              lucroEfetivo,
              valorFipe: param.valorFipe || null,
              diferencaFipe,
              percentualPagamentoSobreFipe,
              percentualPagamentoSobreFipePct,
            },
          };
        }

        document.getElementById("valorVenda").addEventListener("blur", function () {
          formatarInputMoeda(this);
        });
        document.getElementById("valorFipe").addEventListener("blur", function () {
          formatarInputMoeda(this);
        });
        document.getElementById("reparosDiversos").addEventListener("blur", function () {
          formatarInputMoeda(this);
        });

        document.getElementById("valorVenda").addEventListener("focus", limparSeZero);
        document.getElementById("valorFipe").addEventListener("focus", limparSeZero);
        document.getElementById("reparosDiversos").addEventListener("focus", limparSeZero);

        // ==========================
        // pulso discreto no campo destacado quando o valor muda
        // ==========================
        (function () {
          const field = document.getElementById("priorityValorVenda");
          const input = document.getElementById("valorVenda");
          if (!field || !input) return;

          let last = input.value;
          input.addEventListener("change", function () {
            if (input.value !== last) {
              last = input.value;
              field.classList.remove("pulse");
              void field.offsetWidth; // reflow para reiniciar animação
              field.classList.add("pulse");
            }
          });
        })();

        // ==========================
        // Margem: % ou R$
        // ==========================
        const margemTipoEl = document.getElementById("margemTipo");
        const margemPercentEl = document.getElementById("margemPercent");
        const margemValorEl = document.getElementById("margemValor");
        const margemObsEl = document.getElementById("margemObs");

        function atualizarMargemUI() {
          const tipo = margemTipoEl.value;

          if (tipo === "valor") {
            margemPercentEl.style.display = "none";
            margemPercentEl.required = false;
            margemPercentEl.disabled = true;

            margemValorEl.style.display = "block";
            margemValorEl.required = true;
            margemValorEl.disabled = false;

            margemObsEl.textContent = "Informe a margem em valor (R$).";

            // Garante formatação consistente
            formatarInputMoeda(margemValorEl);
          } else {
            margemValorEl.style.display = "none";
            margemValorEl.required = false;
            margemValorEl.disabled = true;

            margemPercentEl.style.display = "block";
            margemPercentEl.required = true;
            margemPercentEl.disabled = false;

            margemObsEl.textContent = "Informe a margem como porcentagem. Por exemplo, digite 15 para 15%.";
          }
        }

        margemTipoEl.addEventListener("change", atualizarMargemUI);
        margemValorEl.addEventListener("blur", function () {
          formatarInputMoeda(this);
        });
        margemValorEl.addEventListener("focus", limparSeZero);

        // Inicializa (mantém % como padrão)
        atualizarMargemUI();

        document.getElementById("formAvaliacao").addEventListener("submit", function (event) {
          event.preventDefault();

          const valorVenda = parseMoedaTexto(document.getElementById("valorVenda").value);
          const numPneus = parseInt(document.getElementById("numPneus").value, 10);
          const numLataria = parseInt(document.getElementById("numLataria").value, 10);
          const margemTipo = margemTipoEl.value;
          let margemPercentual = 0;
          let margemValorInformado = 0;

          if (margemTipo === "valor") {
            margemValorInformado = parseMoedaTexto(margemValorEl.value);
            margemPercentual = valorVenda > 0 ? (margemValorInformado / valorVenda) * 100 : 0;
          } else {
            margemPercentual = parseFloat(margemPercentEl.value);
            margemPercentual = isNaN(margemPercentual) ? 0 : margemPercentual;
            margemValorInformado = (Math.max(0, margemPercentual) / 100) * valorVenda;
          }

          const valorFipe = parseMoedaTexto(document.getElementById("valorFipe").value);
          const reparosDiversos = parseMoedaTexto(document.getElementById("reparosDiversos").value);

          const pagarIpva = document.getElementById("pagarIpva").value;
          const pagamentoIpva = pagarIpva === "sim";

          const params = {
            valorVenda,
            numPneus,
            numLataria,
            margemPercentual,
            margemTipo,
            margemValorInformado,
            valorFipe,
            reparosDiversos,
            pagamentoIpva,
          };

          const resultado = calcularPagamento(params);

          const resultadoDiv = document.getElementById("resultado");
          const valorPagamentoP = document.getElementById("valorPagamento");
          const detalhesLista = document.getElementById("detalhesLista");

          // elementos do badge "% da FIPE"
          const kpiFipeInfo = document.getElementById("kpiFipeInfo");
          const kpiFipePercent = document.getElementById("kpiFipePercent");

          resultadoDiv.style.display = "block";

          const valorFormatado = formatarMoeda(resultado.valorPagamento);
          const partesMoeda = valorFormatado.split(",");

          if (partesMoeda.length === 2) {
            valorPagamentoP.innerHTML = `${partesMoeda[0]},<span class="decimais">${partesMoeda[1]}</span>`;
          } else {
            valorPagamentoP.textContent = valorFormatado;
          }

          valorPagamentoP.style.color = "#0045b3";
          valorPagamentoP.style.fontSize = "3.5rem";
          valorPagamentoP.style.fontWeight = "700";

          // atualizar "% da FIPE" no KPI
          const pct = resultado.detalhes.percentualPagamentoSobreFipePct;
          if (pct !== null && typeof pct === "number" && isFinite(pct)) {
            kpiFipePercent.textContent = pct.toFixed(2) + "%";
            kpiFipeInfo.style.display = "flex";
          } else {
            kpiFipeInfo.style.display = "none";
          }

          detalhesLista.innerHTML = "";
          detalhesLista.className = "detalhes-container";

          const detalhes = resultado.detalhes;

          const impostos = [
            ["PIS/Confins (3,65% da diferença entre venda e compra)", detalhes.custoPisCofins],
            ["ICMS (0,85% da venda)", detalhes.custoIcms],
            ["Custo de IPVA (3% da Tabela Fipe)", detalhes.custoIpva],
          ];

          const despesasVariaveis = [
            ["Custo total com pneus", detalhes.custoPneusTotal],
            ["Custo total com peças de lataria", detalhes.custoLatariaTotal],
            ["Prévia de Manutenção", detalhes.custoReparosDiversos],
            ["Custo de higienização", detalhes.custoHigienizacao],
            ["Custo de polimento", detalhes.custoPolimento],
          ];

          const custosFixos = [
            ["Juros de floor plan (1,5% sobre o valor de compra)", detalhes.jurosFloorPlan],
            ["Comissão do vendedor (0,5% da venda)", detalhes.comissaoVendedor],
            ["Encargos de Comissão/DSR (0,5% da venda)", detalhes.encargosComissao],
            ["__SEPARADOR__", null],
            ["Publicidade", detalhes.custoPublicidade],
            ["Transferência", detalhes.custoTransferencia],
            ["Abracaf", detalhes.custoAbracaf],
            ["Revisão de pátio", detalhes.custoRevisaoPatio],
            ["Lavagem", detalhes.custoLavagem],
            ["Cartório", detalhes.custoCartorio],
          ];

          const resultadosLista = [["Margem desejada", detalhes.margemValor]];

          if (detalhes.valorFipe) {
            resultadosLista.push(["Valor da Tabela Fipe", detalhes.valorFipe]);
            resultadosLista.push(["Diferença entre pagamento e Fipe", detalhes.diferencaFipe]);

            const percentualFormatado =
              detalhes.percentualPagamentoSobreFipePct !== null
                ? detalhes.percentualPagamentoSobreFipePct.toFixed(2) + "%"
                : "";

            resultadosLista.push(["Pagamento em relação à Fipe", percentualFormatado]);
          }

          function criarBox(titulo, lista) {
            const box = document.createElement("div");
            box.className = "detalhes-box";
            const h4 = document.createElement("h4");
            h4.textContent = titulo;
            h4.style.textAlign = "center";
            h4.style.color = "#1f2d5c";
            h4.style.marginTop = "0";
            h4.style.marginBottom = "0.75rem";
            h4.style.fontSize = "1.15rem";
            h4.style.fontWeight = "700";
            box.appendChild(h4);

            const ul = document.createElement("ul");
            lista.forEach(function ([descricao, valor]) {
              if (descricao === "__SEPARADOR__") {
                const hr = document.createElement("hr");
                hr.className = "det-separator";
                ul.appendChild(hr);
                return;
              }

              const li = document.createElement("li");
              const textoValor = typeof valor === "number" ? formatarMoeda(valor) : valor;
              let mainText = descricao;
              let parens = "";
              const parenMatch = descricao.match(/\([^\)]+\)/);
              if (parenMatch) {
                parens = parenMatch[0];
                mainText = descricao.replace(parens, "").trim();
              }
              li.innerHTML =
                '<span class="det-texto">' +
                '<span class="descricao">' +
                mainText +
                "</span>" +
                (parens ? '<span class="subinfo">' + parens + "</span>" : "") +
                ": " +
                "</span>" +
                '<span class="valor">' +
                textoValor +
                "</span>";
              ul.appendChild(li);
            });

            box.appendChild(ul);
            return box;
          }

          detalhesLista.appendChild(criarBox("Resultados da Análise", resultadosLista));
          detalhesLista.appendChild(criarBox("Impostos", impostos));
          detalhesLista.appendChild(criarBox("Despesas variáveis", despesasVariaveis));
          detalhesLista.appendChild(criarBox("Custos fixos - NBS", custosFixos));
        });
      })();
    </script>
  </body>
</html>
